<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> ì¡°íšŒ </title>
    <style>

        #wrapper {
            padding: 30px;
        }

        #info {
            list-style-type: none;
            padding: 0;
            height: 40px;
            min-width: 850px;
        }

        #info::after {
            content: "";
            clear: both;
            display: block;
        }

        #info > li {
            float: left;
            width: 22%;
            line-height: 40px;
        }

        #info > li:first-child {
            width: 12%;
        }

        .dropdown {
            position: relative;
        }

        .dropdown button {
            position: absolute;
            right: 0;
        }

        #info>li:last-child {
            line-height: inherit;
        }

        #imageContainer {
            margin-bottom: 30px;
        }

        #imageContainer::after {
            content: ""; display: block; clear: both;
        }

        #imageWrapper {
            float: left;
        }

        #commentContainer {
            padding: 35px;
        }

        #commentContainer .comment-username {
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 0;
            height: 33px;
        }

        #commentContainer .comment-delete {
            display: block;
            position: absolute;
            right: 10px;
            top: 6px;
            text-decoration: none;
            text-indent: 5px;
        }

        #commentContainer .comment-content {
            border-top-right-radius: 0;
            border-top-left-radius: 0;
            background-color: white;
        }

        #commentContainer .btn {
            border-top-right-radius: 0;
        }

        #commentContainer .comment-update {
            border-bottom-right-radius: 0.375rem;
        }

        #commentHeader {
            font-size: 1.2em;
            margin-bottom: 20px;
            text-indent: 0.5em;
        }

       #commentContainer .other-comment {
            margin-bottom: 20px;
           position: relative;
        }

        .other-comment .comment-update-submit {
            display: none;
        }

    </style>
    <script src="https://code.jquery.com/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
          rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi"
          crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" th:href="@{/css/nav-css.css}">
    <script>
        $(function () {

            let commentMessage = ""
            // commentMessage ì½ê¸° (th:if ë¡œ messageComment ìˆìœ¼ë©´ ìì‹ ì¡´ì¬)
            if($("#message").children().length > 0) {
                commentMessage = $("#message").children().first().data("message");
                alert(commentMessage);
            }


            // ê²Œì‹œê¸€ ì‚­ì œ
            $(".delete").on("click", function () {
                // confirm: NO ëˆ„ë¥´ë©´ FALSE ë°˜í™˜
                if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    // ê¸°ë³¸ ì´ë²¤íŠ¸ ì œê±°
                    // jQuery ì—ì„œ return false; ëŠ” preventDefault() + stopPropagation()
                    return false;
                }
            });

            // ê²€ìƒ‰ì¤‘ ì´ë²¤íŠ¸ ë³€ê²½
            $(".searching-nav>button").on("click", function (event) {
                event.preventDefault();

                // ì´ë™í•  ìœ í˜• (list, update, delete)
                let action = $(this).attr("data-action");

                // pathVariable ë¶™ì´ë ¤ê³  ì„ ì–¸
                let boardId = $("#info>li:first-child").attr("data-boardId");

                // url ìƒì„±
                let url = "/board/" + action;

                // /list ì•„ë‹ˆë©´ pathVariable ë¶™ì„
                if (action != "list") url += "/" + boardId

                // input hiddenì— ë‹´ì•„ submit
                $("#pageInfo").attr("action", url).submit();
            })

            // ëŒ“ê¸€ ìˆ˜ì • ê²€ì‚¬
            $(".comment-update").on("click", function (event) {
                let myWriter = $("#myWriter").val();

                // íƒ€ì„ë¦¬í”„ë¡œ other-comment ë§ˆë‹¤ #commentN (N=state.count) ë¡œ id ë¶€ì—¬
                let commentId = $(this).data("id");
                // í•´ë‹¹ id ë¡œ íƒìƒ‰
                let writer = $("#comment" + commentId + " .comment-writer").val();

                console.log("writer = " + writer + " mywriter = " + myWriter);

                if (myWriter == null) { alert("ë¡œê·¸ì¸ í•´ ì£¼ì„¸ìš”"); return false; }

                if (writer == myWriter) {
                    let content = $("#comment" + commentId + " .comment-content").attr("placeholder");
                    $("#comment" + commentId + " .comment-content").val(content);
                    $(this).prev().attr({ disabled: false, required: true });
                    $("#comment" + commentId + " .comment-username").addClass("bg-primary text-white");

                    // delete ë²„íŠ¼ ì œê±°
                    $(this).parent().prev().css("display", "none");

                    // ë²„íŠ¼ ë“±ë¡ìœ¼ë¡œ ë°”ê¿ˆ
                    $(this).css("display", "none").next().css("display", "block");
                    // ê¸°ë³¸ê°’ ì„¤ì •

                } else {
                    alert("ìˆ˜ì •í•˜ë ¤ëŠ” ëŒ“ê¸€ì˜ ì‘ì„±ìê°€ ì•„ë‹™ë‹ˆë‹¤.");
                }
            })

            // ëŒ“ê¸€ ì‚­ì œ ê²€ì‚¬
            $(".comment-delete").on("click", function (event) {
                console.log("event delete");
                event.preventDefault();
                let targetWriter = $(this).prev().text();
                let myWriter = $("#myWriter").val();
                let commentId = $(this).data("id");

                if (myWriter == null) { alert("ë¡œê·¸ì¸ í•´ ì£¼ì„¸ìš”"); return false; }

                if (myWriter == targetWriter) {
                    // delete ë¡œ ì´ë™
                    window.location.replace("/comment/delete/" + commentId);
                } else {
                    alert("ì‚­ì œí•˜ë ¤ëŠ” ëŒ“ê¸€ì˜ ì‘ì„±ìê°€ ì•„ë‹™ë‹ˆë‹¤.");
                }
            })

            // ëŒ“ê¸€ ìˆ˜ì •
            $(".comment-update-submit").on("click", function (event) {

                let commentId = $(event.target).prev().data("id");
                let content = $("#comment" + commentId + " textarea").val();

                if (isContentEmpty(content)) {
                    alert("ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                    return false;
                }

                console.log("commentId = " + commentId + "content = " + content)

                $.ajax({
                    type: "post",
                    async: false,
                    url: "/comment/update/" + commentId,
                    data: {content: content},
                    success: function (result) {
                        console.log("result = " + result);
                        alert("ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        location.reload();
                    },
                    //ajax ì—ëŸ¬í™•ì¸
                    error: function (request, status, error) {
                        console.log("code: " + request.status)
                        console.log("message: " + request.responseText)
                        console.log("error: " + error);
                    }
                })
            })

            function isContentEmpty(content) {
                return (content == "" || content == null) ? true : false;
            }

        });
    </script>
</head>
<body>
<div id="container" class="container-lg">

    <nav th:replace="fragment/fragment.html :: nav-fragment">
    </nav>

    <div id="wrapper">

        <h2 th:text="${board.title}"> Title </h2>

        <hr>

        <ul id="info">
            <li th:data-boardId="${board.id}">
                <span>ë²ˆí˜¸: </span>
                <span th:text="${board.id}">ë²ˆí˜¸</span>
            </li>
            <li>
                <span>ì‘ì„±ì: </span>
                <span th:text="${board.writer}">ì‘ì„±ì</span>
            </li>
            <li>
                <span>ì‘ì„±: </span>
                <span th:text="${#temporals.format(board.regedate, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì‹œê°„</span>
            </li>
            <li>
                <span>ìˆ˜ì •:</span>
                <span th:text="${#temporals.format(board.updateDate, 'yyyy-MM-dd HH:mm')}" >ìˆ˜ì •ì‹œê°„</span>
            </li>
            <li th:if="${!imageList.isEmpty()}">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        ì²¨ë¶€ íŒŒì¼
                    </button>
                    <ul class="dropdown-menu">
                        <li th:each="image : ${imageList}">
                            <a th:text="${image.getUploadImageName()}" class="dropdown-item" href="#">ImageName</a>
                        </li>
                    </ul>
                </div>
            </li>
        </ul>

        <hr>

        <!-- ì´ë¯¸ì§€ -->
        <div id="imageContainer">
            <div id="imageWrapper">
                <img th:each="image : ${imageList}" th:src="|/images/${image.getStoreImageName()}|"
                     width="400">
            </div>
        </div>

        <!-- ê¸€ ë‚´ìš© -->
        <p th:text="${board.content}" id="article">Content</p>

        <hr>

        <!-- ê²€ìƒ‰ì¤‘ -->
        <div class="btn-group searching-nav" role="group"  th:if="${criteria.option != null}">
            <button type="button" class="btn btn-primary" th:data-action="list">List</button>
            <button type="button" class="btn btn-primary" th:data-action="edit">Update</button>
            <button type="button" class="btn btn-primary delete" th:data-action="delete">Delete</button>
        </div>

        <!-- ê²€ìƒ‰ ì•ˆí•¨ -->
        <div class="btn-group" role="group" th:if="${criteria.option == null}">
            <button type="button" class="btn btn-primary" onclick="location.href='/board/list'"
                    th:onclick="|location.href='@{/board/list(currentPage=${criteria.currentPage})}'|">List
            </button>
            <button type="button" class="btn btn-primary" onclick="location.href='/board/list'"
                    th:onclick="|location.href='@{/board/edit/{boardId}(boardId=${board.id}, currentPage=${criteria.currentPage})}'|">
                Update
            </button>
            <button type="button" class="btn btn-primary delete" onclick="location.href='/board/list'"
                    th:onclick="|location.href='@{/board/delete/{boardId}(boardId=${board.id}, currentPage=${criteria.currentPage})}'|">
                Delete
            </button>
        </div>
    </div>

    <!-- ëŒ“ê¸€ -->
    <div id="commentContainer">
        <div id="commentHeader" th:text="'ğŸ’¬ ' + ${commentList.size()} + 'ê°œì˜ ëŒ“ê¸€'">
            ğŸ’¬ 00ê°œì˜ ëŒ“ê¸€
        </div>
        <div class="other-comment" th:each="comment, commentState : ${commentList}" th:id="'comment'+ ${comment.getCommentId()}">
            <!-- th placeholder comment.username -->
            <input type="hidden" class="comment-writer form-control" th:value="${comment.writer}" name="writer">
            <!-- th text comment.username -->
            <span class="input-group-text comment-username" th:text="${comment.writer}">writer</span>
            <a class="comment-delete" th:href="@{/comment/delete/{commentId}(commentId=${comment.getCommentId()})}"
                th:data-id="${comment.getCommentId()}">âœ–</a>
            <div class="input-group">
                <textarea class="comment-content form-control form-control-sm" name="content" th:placeholder="${comment.content}" disabled maxlength="50"></textarea>
                <button class="btn btn-outline-secondary comment-update" type="button" th:data-id="${comment.getCommentId()}"
                        >ìˆ˜ì •</button>
                <button class="btn btn-outline-secondary comment-update-submit" type="button">ë“±ë¡</button>
            </div>
            <input type="hidden" name="boardId" value="0" th:value="${boardId}">
        </div>
        <div id="myComment" th:if="${session.loginMember != null}">
            <form th:action="@{/comment/write}" method="post">
                <input id="myWriter" type="hidden" class="form-control" name="writer" th:value="${session.loginMember.getUsername()}">
                <span class="input-group-text comment-username bg-primary text-white" th:text="${session.loginMember.getUsername()}">username</span>
                <div class="input-group">
                    <textarea class="comment-content form-control form-control-sm" name="content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required maxlength="50"></textarea>
                    <button class="btn btn-outline-secondary comment-submit" type="submit">ë“±ë¡</button>
                </div>
                <input type="hidden" name="boardId" value="0" th:value="${boardId}">
            </form>
        </div>
    </div>



    <!-- ê²€ìƒ‰ ì •ë³´ -->
    <form id="pageInfo" method="get">
        <input type="hidden" th:name="currentPage" th:value="${criteria.currentPage}">
        <input type="hidden" th:name="option" th:value="${criteria.option}">
        <input type="hidden" th:name="keyword" th:value="${criteria.keyword}">
    </form>

    <!-- message, ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ rttr ë¡œ ë„˜ê²¨ë°›ëŠ” commentMessage -->
    <div style="display: none" id="message">
        <div style="display: none" th:if="${commentMessage}" th:data-message="${commentMessage}"></div>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>
</body>
</html>